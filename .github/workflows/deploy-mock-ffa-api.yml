name: Deploy Mock FFA API to Cloud Run

on:
  push:
    branches:
      - main
    paths:
      - 'mock-ffa-api/**'
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_NAME: mock-ffa-api
  REGION: us-central1

jobs:
  deploy:
    name: Deploy Mock FFA API to Cloud Run
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Secrets
        run: |
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "‚ùå Error: GCP_SA_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.GCP_PROJECT_ID }}" ]; then
            echo "‚ùå Error: GCP_PROJECT_ID secret is not set"
            exit 1
          fi
          echo "‚úÖ Secrets verified"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Create Artifact Registry repository (if not exists)
        run: |
          gcloud artifacts repositories create cc-ems-repo \
            --repository-format=docker \
            --location=${{ env.REGION }} \
            --description="CC EMS Docker images" \
            --quiet || echo "Repository already exists"

      - name: Build Docker image
        working-directory: ./mock-ffa-api
        run: |
          echo "üê≥ Building Docker image..."
          docker build -t us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cc-ems-repo/${{ env.SERVICE_NAME }}:latest .
          docker tag us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cc-ems-repo/${{ env.SERVICE_NAME }}:latest \
            us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cc-ems-repo/${{ env.SERVICE_NAME }}:${{ github.sha }}

      - name: Push Docker image
        run: |
          echo "üì§ Pushing Docker image..."
          docker push us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cc-ems-repo/${{ env.SERVICE_NAME }}:latest
          docker push us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cc-ems-repo/${{ env.SERVICE_NAME }}:${{ github.sha }}

      - name: Deploy to Cloud Run
        run: |
          echo "üöÄ Deploying Mock FFA API to Cloud Run..."
          
          # Check if service exists
          SERVICE_EXISTS=false
          if gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }} \
            --quiet 2>/dev/null; then
            echo "‚ÑπÔ∏è Service exists, will update..."
            SERVICE_EXISTS=true
          else
            echo "‚ÑπÔ∏è Service does not exist, will create..."
          fi
          
          # Get EMS backend URL for mock to fetch masters (Option A)
          EMS_BACKEND_URL=""
          if gcloud run services describe cc-ems-backend --region ${{ env.REGION }} --project ${{ secrets.GCP_PROJECT_ID }} --format 'value(status.url)' 2>/dev/null; then
            EMS_BACKEND_URL=$(gcloud run services describe cc-ems-backend --region ${{ env.REGION }} --project ${{ secrets.GCP_PROJECT_ID }} --format 'value(status.url)' 2>/dev/null)
          fi
          if [ -z "$EMS_BACKEND_URL" ]; then
            echo "‚ö†Ô∏è EMS backend (cc-ems-backend) not found; mock will use fallback crops/products until EMS is deployed"
          else
            echo "‚úÖ EMS backend URL for masters: $EMS_BACKEND_URL"
          fi

          # Build env vars for mock: EMS_API_URL (backend URL) and FFA_MASTER_KEY (from secret)
          MOCK_ENV_ARGS=""
          if [ -n "$EMS_BACKEND_URL" ]; then
            MOCK_ENV_ARGS="--set-env-vars=EMS_API_URL=$EMS_BACKEND_URL"
          fi
          if [ -n "${{ secrets.FFA_MASTER_KEY }}" ]; then
            if [ -n "$MOCK_ENV_ARGS" ]; then
              MOCK_ENV_ARGS="$MOCK_ENV_ARGS,FFA_MASTER_KEY=${{ secrets.FFA_MASTER_KEY }}"
            else
              MOCK_ENV_ARGS="--set-env-vars=FFA_MASTER_KEY=${{ secrets.FFA_MASTER_KEY }}"
            fi
          fi
          if [ -z "$MOCK_ENV_ARGS" ]; then
            echo "‚ö†Ô∏è Set FFA_MASTER_KEY secret and deploy EMS first so mock can load masters from EMS"
          fi

          # Deploy service
          if [ "$SERVICE_EXISTS" = "false" ]; then
            echo "üÜï Creating new service..."
            gcloud run deploy ${{ env.SERVICE_NAME }} \
              --image us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cc-ems-repo/${{ env.SERVICE_NAME }} \
              --platform managed \
              --region ${{ env.REGION }} \
              --allow-unauthenticated \
              --port 8080 \
              --memory 256Mi \
              --cpu 1 \
              --min-instances 0 \
              --max-instances 1 \
              $MOCK_ENV_ARGS \
              --project ${{ secrets.GCP_PROJECT_ID }} \
              --quiet
          else
            echo "üîÑ Updating existing service..."
            gcloud run deploy ${{ env.SERVICE_NAME }} \
              --image us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cc-ems-repo/${{ env.SERVICE_NAME }} \
              --platform managed \
              --region ${{ env.REGION }} \
              --max-instances 1 \
              $MOCK_ENV_ARGS \
              --project ${{ secrets.GCP_PROJECT_ID }} \
              --quiet
          fi
          
          # Get service URL
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }} \
            --format 'value(status.url)')
          
          echo "‚úÖ Mock FFA API deployed successfully!"
          echo "üîó Service URL: $SERVICE_URL"
          echo "üìù Update FFA_API_URL in backend deployment to: $SERVICE_URL/api"
